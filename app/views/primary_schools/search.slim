h1 小学校区検索

h3 学区を知りたい地点をクリックして「この地点の学区の小学校を検索する」ボタンを押すと、その地点が学区の小学校が黒丸で表示されます。

= form_tag primary_schools_path, method: :get
  = hidden_field_tag :lat, params[:lat]
  = hidden_field_tag :lng, params[:lng]
  div 
    | クリックした地点:
    span#address
  = button_tag 'この地点の学区の小学校を検索する'

- if @results

  - @results.each do |primary_school|
    article
      - properties = primary_school._source.properties
      h3
        | #{properties.a27_006}#{properties.a27_007}
        span.school-address data-school-address="#{properties.a27_008}" = " (所在地: #{properties.a27_008})"

  - if @results.count == 0
    p 該当地点のデータは登録されていません

#map

javascript:
  var markers = [];
  var initialized = false;
  var geocoder = new google.maps.Geocoder();

  // https://stackoverflow.com/questions/10375925/get-address-after-clicking-in-the-map
  function getAddress(latLng) {
    geocoder.geocode( {'latLng': latLng},
      function(results, status) {
        if(status == google.maps.GeocoderStatus.OK) {
          if(results[0]) {
            $('#address').html(results[0].formatted_address);
          }
          else {
            $('#address').html("No results");
          }
        }
        else {
          $('#address').html(status);
        }
      }
    );
  }

  function codeAddress(map) {
  
    var address = $('.school-address').first().attr('data-school-address');
  
    geocoder.geocode( { 'address' : address }, function( results, status ) {
      if( status == google.maps.GeocoderStatus.OK ) {

        var marker = new google.maps.Marker({
          position: results[0].geometry.location,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 10
          },
          map: map
        });
        markers.push(marker);
        var bounds = new google.maps.LatLngBounds();
        for (var i = 0; i < markers.length; i++) {
         bounds.extend(markers[i].getPosition());
        }
        map.fitBounds(bounds); 
      } else {
          alert( 'Geocodeは次の理由で失敗しました: ' + status );
      }
    } );
  }

  function addMarker(position, map) {
    $('#lat').val(position.lat());
    $('#lng').val(position.lng());
    var marker = new google.maps.Marker({
      position: position,
      map: map
    });
    markers.push(marker);
    getAddress(position);
    if(0 < $('.school-address').length && false == initialized) {
      codeAddress(map);
    }
  }
  handler = Gmaps.build('Google');
  var window_width = $(window).width() * 0.95;
  $('#map').width(window_width);
  // 画面が横長か縦長かで高さを分岐
  if($(window).width() < $(window).height()) {
    $('#map').height(window_width * 0.8);
  } else {
    $('#map').height(window_width * 0.3);
  }
  handler.buildMap({ provider: {}, internal: {id: 'map'}}, function(){
    handler.getMap().setCenter(#{raw @hash.first.to_json});
    handler.getMap().setZoom(15);
    google.maps.event.addListener(handler.getMap(), 'bounds_changed', function(object){
      if(false == initialized) {
        addMarker(handler.getMap().getCenter(), handler.getMap());
        initialized = true;
      }
    });
    google.maps.event.addListener(handler.getMap(), 'click', function(object){
      for (var i = 0; i < markers.length; i++) {
        markers[i].setMap(null);
      }
      addMarker(object.latLng, handler.getMap());
    });
  });

